name: pytest-workflow test

on: [push]

jobs:
  list-tags:
    runs-on: ubuntu-latest
    outputs:
        tags: ${{ steps.set-tags.outputs.tags }}
    steps:
        - name: checkout
          uses: actions/checkout@v4
        - name: set tags
          id: set-tags
          run: echo "tags=$(find tests -name '*.yaml' -exec ~/Downloads/yq_darwin_amd64 --output-format yaml '.[].tags[] ' {} \;| sort | uniq | grep -vE 'deprecated|miniwdl|cellranger') | jq -ncR '[inputs]'" >> $GITHUB_OUTPUT
  pytest_check:
    needs: list-tags
    runs-on: ubuntu-latest
    strategy:
      matrix:
        tag: ${{ fromJson(needs.list-tags.outputs.tags) }}
    steps:
    - uses: actions/checkout@v4
      with:
        lfs: true
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    - name: Install miniwdl and pytest-workflow
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements-dev.txt
    - name: pull image
      run: |
        docker pull quay.io/biocontainers/gtfparse:2.5.0--pyh7cba7a3_0 &&
        docker pull quay.io/biocontainers/gtfparse:1.2.1--pyh864c0ab_0
    - name: Run pytest-workflow
      run: |
        pytest --git-aware --basetemp /home/runner/work/pytest --symlink --tag ${{ matrix.tag }}