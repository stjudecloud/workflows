on:
    pull_request:
      types:
        - closed

env:
  REGISTRY: ghcr.io

jobs:
    list-images:
        runs-on: ubuntu-latest
        outputs:
          images: ${{ steps.set-matrix.outputs.images }}
        steps:
          - name: checkout
            uses: actions/checkout@v3
            with:
                fetch-depth: 0
          - name: set matrix
            id: set-matrix
            run: echo "images=$(find docker -maxdepth 1 -mindepth 1 | jq --raw-input --slurp --compact-output 'split("\n")[:-1]')" >> $GITHUB_OUTPUT
    if_merged:
        if: github.event.pull_request.merged == true
        needs: list-images
        runs-on: ubuntu-latest
        strategy:
            matrix:
                image: ${{ fromJson(needs.list-images.outputs.images) }}
        steps:
          - name: Set Env
            run: |
              echo "TOOL=$(jq -r .name ${{ matrix.image }}/package.json)" >> $GITHUB_ENV
              echo "SEMVER=$(jq -r .version ${{ matrix.image }}/package.json)" >> $GITHUB_ENV
              echo "REVISION=$(jq -r .revision ${{ matrix.image }}/package.json)" >> $GITHUB_ENV
              echo "GH_REF=${GITHUB_REF##*/}" >> $GITHUB_ENV
          - name: Set Branch Tag
            if: github.ref != 'refs/heads/main'
            run: |
                if [ ${{ env.REVISION }} != "null" ]; then
                    echo "IMAGE_TAG=branch-${{ env.GH_REF }}-${{ env.SEMVER }}-${{ env.REVISION }}" >> $GITHUB_ENV
                else
                    echo "IMAGE_TAG=branch-${{ env.GH_REF }}-${{ env.SEMVER }}" >> $GITHUB_ENV
                fi
          - uses: actions/delete-package-versions@v5
            with: 
                package-name: ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.TOOL }}
                package-type: 'container'
                package-version-ids: ${{ env.IMAGE_TAG }}