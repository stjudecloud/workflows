name: Workflows Docker Branch

on:
  push:
    branches-ignore:
    - 'master'

env:
  REGISTRY: ghcr.io

jobs:
  build-matrix:
    runs-on: ubuntu-latest
    outputs:
      images: ${{ steps.set-matrix.outputs.images }}
    steps:
      - name: checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
  
      - name: set matrix
        id: set-matrix
        run: echo "images=$(find docker -maxdepth 2 -mindepth 2 -not -path "*/cellranger/*"| jq --raw-input --slurp --compact-output 'split("\n")[:-1]')" >> $GITHUB_OUTPUT

  build-images:
    needs: build-matrix
    runs-on: ubuntu-latest
    strategy:
      matrix:
        image: ${{ fromJson(needs.build-matrix.outputs.images) }}
    steps:
      - name: Set Env
        run: |
          echo "TOOL=$(basename `dirname "${{ matrix.image }}"`)" >> $GITHUB_ENV
          echo "TAG=$(basename "${{ matrix.image }}")" >> $GITHUB_ENV
      - name: Verify SemVer
        run: |
          if ! [[ $TAG =~ ^(0|[1-9]\d*)\.(0|[1-9]\d*)\.(0|[1-9]\d*)(-(0|[1-9]\d*|\d*[a-zA-Z-][0-9a-zA-Z-]*)(\.(0|[1-9]\d*|\d*[a-zA-Z-][0-9a-zA-Z-]*))*)?(\+[0-9a-zA-Z-]+(\.[0-9a-zA-Z-]+)*)?$ ]]; then
            >&2 echo "Tag subdirectory $TAG for tool $TOOL is not SemVer compliant."
            >&2 echo "This container will not be built."
            exit 1
          fi
      - name: Log in to the Container registry
        uses: docker/login-action@f054a8b539a109f9f41c372932f1ae047eff08c9
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - uses: actions/checkout@v2
      - uses: webfactory/ssh-agent@v0.5.2
        with:
          ssh-private-key: ${{ secrets.STJUDE_SEQERR_READONLY_DEPLOY_KEY }}
      - name: Build and push docker images
        env:
          REGISTRY: ${{ env.REGISTRY }}
          REPO_OWNER: ${{ github.repository_owner }}
        run: |
          tag=branch-${GITHUB_REF##*/}-$TAG
          DOCKER_BUILDKIT=1 docker buildx build --push --ssh default -t "$REGISTRY"/"$REPO_OWNER"/"$TOOL":"$tag" ${{ matrix.image }}
          docker rmi "$REGISTRY"/"$REPO_OWNER"/"$TOOL":"$tag"