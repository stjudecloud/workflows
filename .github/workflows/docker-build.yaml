name: Workflows Docker Build

on:
  workflow_call:

env:
  REGISTRY: ghcr.io

jobs:
  list-images:
    runs-on: ubuntu-latest
    outputs:
      images: ${{ steps.set-matrix.outputs.images }}
    steps:
      - name: checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: set matrix
        id: set-matrix
        run: echo "images=$(find docker -maxdepth 1 -mindepth 1 | jq --raw-input --slurp --compact-output 'split("\n")[:-1]')" >> $GITHUB_OUTPUT

  build-images:
    needs: list-images
    strategy:
      matrix:
        image: ${{ fromJson(needs.list-images.outputs.images) }}
        exclude:
          - image: 'hilow'
      fail-fast: false
    uses: ./.github/workflows/docker-build-image.yaml
    secrets: inherit
    with:
      image: ${{ matrix.image }}

  build-dependent-images:
    needs: build-images
    strategy:
      matrix:
        image: ['hilow']
      fail-fast: false
    uses: ./.github/workflows/docker-build-image.yaml
    secrets: inherit
    with:
      image: ${{ matrix.image }}