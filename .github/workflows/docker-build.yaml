name: Workflows Docker Build

on:
  push:

env:
  REGISTRY: ghcr.io

jobs:
  list-images:
    runs-on: ubuntu-latest
    outputs:
      images: ${{ steps.set-matrix.outputs.images }}
    steps:
      - name: checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: set matrix
        id: set-matrix
        run: echo "images=$(find docker -maxdepth 1 -mindepth 1 | jq --raw-input --slurp --compact-output 'split("\n")[:-1]')" >> $GITHUB_OUTPUT

  build-images:
    needs: list-images
    runs-on: ubuntu-latest
    strategy:
      matrix:
        image: ${{ fromJson(needs.list-images.outputs.images) }}
    steps:
      - uses: actions/checkout@v3
      - name: Set Env
        run: |
          echo "TOOL=$(jq -r .name ${{ matrix.image }}/package.json)" >> $GITHUB_ENV
          echo "SEMVER=$(jq -r .version ${{ matrix.image }}/package.json)" >> $GITHUB_ENV
          echo "GH_REF=${GITHUB_REF##*/}" >> $GITHUB_ENV
      - name: Set Main Tag
        if: github.ref == 'refs/heads/main'
        run: echo "IMAGE_TAG=${{ env.SEMVER }}" >> $GITHUB_ENV
      - name: Set Branch Tag
        if: github.ref != 'refs/heads/main'
        run: echo "IMAGE_TAG=branch-${GITHUB_REF##*/}-${{ env.SEMVER }}" >> $GITHUB_ENV
      - name: Log in to the Container registry
        run: echo ${{ secrets.GITHUB_TOKEN }} | docker login ${{ env.REGISTRY }} --username ${{ github.actor }} --password-stdin
      - uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.STJUDE_SEQERR_READONLY_DEPLOY_KEY }}
      - uses: docker/setup-qemu-action@v2
      - uses: docker/setup-buildx-action@v2
        id: build
      - uses: docker/build-push-action@v4
        with:
          context: ${{ matrix.image }}
          build-contexts: scripts=./scripts
          push: false
          ssh: default
          tags: ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.TOOL }}:local
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.TOOL }}:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.TOOL }}:buildcache,mode=max
      - name: Check digest
        if: github.ref == 'refs/heads/main'
        run: |
          remote_digest=$(docker inspect ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.TOOL }}:${{ env.IMAGE_TAG }} --format='{{index .RepoDigests 0}}')
          local_digest=${{ steps.build.outputs.digest }}
          if [ "$remote_digest" != "$local_digest" ]; then
            echo "Digests do not match!"
            echo "Remote: $remote_digest"
            echo "Local: $local_digest"
            exit 1
          fi
      - name: Push image
        run: |
          docker tag ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.TOOL }}:local ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.TOOL }}:${{ env.IMAGE_TAG }}
          docker push ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.TOOL }}:${{ env.IMAGE_TAG }}
